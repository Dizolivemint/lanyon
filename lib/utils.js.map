{"version":3,"sources":["../src/utils.js"],"names":["semver","require","fs","path","scrolex","yaml","shell","spawnSync","main","module","failure","process","exit","exports","preferLocalPackage","args","filename","appDir","name","entry","version","localModulePackage","absoluteEntry","realpathSync","e","type","exe","shift","i","stdio","dockerCmd","cmd","flags","cacheDir","projectDir","lanyonVersion","join","upwardDirContaining","find","cwd","not","env","PWD","parts","split","length","newParts","ppath","test","undefined","basename","dirname","pop","initProject","assetsBuildDir","gitRoot","binDir","mkdir","exec","relative","writeConfig","cfg","runtime","writeFileSync","safeDump","jekyll","JSON","stringify","nodemon","lanyonDir","recordsPath","dBuf","gBuf","gems","satisfied","app","checkOn","prerequisites","rubyProvidersSkip","tag","indexOf","range","appVersionFull","stdout","trim","appVersion","satisfies","stick"],"mappings":"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","file":"utils.js","sourcesContent":["const semver     = require('semver')\nconst fs         = require('fs')\n// const _       = require('lodash')\nconst path       = require('path')\nconst scrolex    = require('scrolex')\nconst yaml       = require('js-yaml')\nconst shell      = require('shelljs')\nconst spawnSync  = require('spawn-sync')\n\nif (require.main === module) {\n  scrolex.failure(`Please only used this module via require`)\n  process.exit(1)\n}\n\nmodule.exports.preferLocalPackage = (args, filename, appDir, name, entry, version) => {\n  let localModulePackage\n  let absoluteEntry\n  try {\n    localModulePackage = require(`${appDir}/node_modules/${name}/package.json`)\n    absoluteEntry      = fs.realpathSync(`${appDir}/node_modules/${name}/${entry}`)\n  } catch (e) {\n    localModulePackage = {}\n    absoluteEntry      = false\n  }\n\n  if (localModulePackage.version && absoluteEntry) {\n    if (filename === absoluteEntry) {\n      return { type: 'symlinked', version: localModulePackage.version }\n    } else {\n      // We're entering globally and replacing this with a local instance\n      const exe = args.shift()\n      for (const i in args) {\n        // Replace the current entry, e.g. /usr/local/frey/lib/cli.js with the local package\n        if (args[i] === filename) {\n          args[i] = absoluteEntry\n        }\n      }\n      spawnSync(exe, args, { stdio: 'inherit' })\n      process.exit(0)\n      // return { type: 'local', version: localModulePackage.version }\n    }\n  } else {\n    return { type: 'local', version: version }\n  }\n}\n\nmodule.exports.dockerCmd = ({cacheDir, projectDir, lanyonVersion}, cmd, flags) => {\n  if (!flags) {\n    flags = ''\n  }\n  return [\n    'docker run',\n    ` ${flags}`,\n    ' --rm',\n    ` --workdir ${cacheDir}`,\n    ' --user $(id -u)',\n    ` --volume ${cacheDir}:${cacheDir}`,\n    ` --volume ${projectDir}:${projectDir}`,\n    ` kevinvz/lanyon:${lanyonVersion}`,\n    ` ${cmd}`,\n  ].join('')\n}\n\nmodule.exports.upwardDirContaining = (find, cwd, not) => {\n  if (!cwd) {\n    cwd = process.env.PWD || process.cwd()\n  }\n  const parts = cwd.split('/')\n  while (parts.length) {\n    const newParts = parts\n    const ppath = `${newParts.join('/')}/${find}`\n    if (shell.test('-f', ppath) || shell.test('-d', ppath)) {\n      if (not === undefined || not !== path.basename(path.dirname(ppath))) {\n        return path.dirname(ppath)\n      }\n    }\n    parts.pop()\n  }\n  return false\n}\n\nmodule.exports.initProject = ({assetsBuildDir, gitRoot, cacheDir, binDir}) => {\n  if (!shell.test('-d', assetsBuildDir)) {\n    shell.mkdir('-p', assetsBuildDir)\n    shell.exec(`cd ${path.dirname(gitRoot)} && git ignore ${path.relative(gitRoot, assetsBuildDir)}`)\n  }\n  if (!shell.test('-d', cacheDir)) {\n    shell.mkdir('-p', cacheDir)\n    shell.exec(`cd ${path.dirname(gitRoot)} && git ignore ${path.relative(gitRoot, cacheDir)}`)\n  }\n  if (!shell.test('-d', binDir)) {\n    shell.mkdir('-p', binDir)\n    shell.exec(`cd ${path.dirname(gitRoot)} && git ignore ${path.relative(gitRoot, binDir)}`)\n  }\n}\n\nmodule.exports.writeConfig = cfg => {\n  if (!shell.test('-f', `${cfg.runtime.cacheDir}/jekyll.lanyon_assets.yml`)) {\n    fs.writeFileSync(`${cfg.runtime.cacheDir}/jekyll.lanyon_assets.yml`, '# this file should be overwritten by the Webpack AssetsPlugin', 'utf-8')\n  }\n  fs.writeFileSync(`${cfg.runtime.cacheDir}/jekyll.config.yml`, yaml.safeDump(cfg.jekyll), 'utf-8')\n  fs.writeFileSync(`${cfg.runtime.cacheDir}/nodemon.config.json`, JSON.stringify(cfg.nodemon, null, '  '), 'utf-8')\n  fs.writeFileSync(`${cfg.runtime.cacheDir}/full-config-dump.json`, JSON.stringify(cfg, null, '  '), 'utf-8')\n  fs.writeFileSync(`${cfg.runtime.cacheDir}/browsersync.config.js`, `module.exports = require(\"${cfg.runtime.lanyonDir}/lib/config.js\").browsersync`, 'utf-8')\n  fs.writeFileSync(`${cfg.runtime.cacheDir}/webpack.config.js`, `module.exports = require(\"${cfg.runtime.lanyonDir}/lib/config.js\").webpack`, 'utf-8')\n  fs.writeFileSync(cfg.runtime.recordsPath, JSON.stringify({}, null, '  '), 'utf-8')\n\n  let dBuf = ''\n  dBuf    += 'FROM ruby:2.3.3-alpine\\n'\n  dBuf    += 'RUN mkdir -p /jekyll\\n'\n  dBuf    += 'WORKDIR /jekyll\\n'\n  dBuf    += 'COPY Gemfile /jekyll/\\n'\n  dBuf    += 'RUN true \\\\\\n'\n  dBuf    += '  && apk --update add make gcc g++ \\\\\\n'\n  dBuf    += '  && bundler install --path /jekyll/vendor/bundler \\\\\\n'\n  dBuf    += '  && bundler update \\\\\\n'\n  dBuf    += '  && apk del make gcc g++ \\\\\\n'\n  dBuf    += '  && rm -rf /var/cache/apk/* \\\\\\n'\n  dBuf    += '  && true\\n'\n  fs.writeFileSync(`${cfg.runtime.cacheDir}/Dockerfile`, dBuf, 'utf-8')\n\n  let gBuf = 'source \\'https://rubygems.org\\'\\n'\n  for (const name in cfg.runtime.gems) {\n    const version = cfg.runtime.gems[name]\n    gBuf         += `gem '${name}', '${version}'\\n`\n  }\n  fs.writeFileSync(path.join(cfg.runtime.cacheDir, 'Gemfile'), gBuf, 'utf-8')\n}\n\nmodule.exports.satisfied = ({prerequisites, rubyProvidersSkip}, app, cmd, checkOn) => {\n  let tag = ''\n  if (checkOn === undefined) {\n    checkOn = app\n  } else {\n    tag = `${checkOn}/`\n  }\n\n  if (rubyProvidersSkip.indexOf(checkOn) !== -1) {\n    scrolex.failure(`${tag}${app} '${prerequisites[app].range} disabled via LANYON_SKIP`)\n    return false\n  }\n\n  if (!cmd) {\n    cmd = `${app} -v`\n  }\n\n  const appVersionFull = shell.exec(cmd, { 'silent': true }).stdout.trim()\n  const parts          = appVersionFull.split(/[,p\\s-]+/)\n  let appVersion       = parts[1]\n\n  if (app === 'node') {\n    appVersion = parts[0]\n  } else if (app === 'bundler') {\n    appVersion = parts[2]\n  } else if (app === 'docker') {\n    appVersion = parts[2]\n  }\n\n  try {\n    if (semver.satisfies(appVersion, prerequisites[app].range)) {\n      scrolex.stick(`${tag}${app} '${prerequisites[app].range} available`)\n      return true\n    }\n  } catch (e) {\n    scrolex.failure(`${tag}${app} '${prerequisites[app].range} unavailable. output: ${appVersionFull}. ${e}`)\n    return false\n  }\n\n  scrolex.failure(`${tag}${app} '${prerequisites[app].range} unavailable. output: ${appVersionFull}`)\n  return false\n}\n"]}