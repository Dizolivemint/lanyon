{"version":3,"sources":["../src/cli.js"],"names":["utils","require","preferLocalPackage","process","argv","__filename","cwd","version","_","config","shell","scrolex","runtime","main","module","failure","exit","scripts","dockerCmd","trace","cmdName","cmd","setOpts","announce","addCommandAsComponent","components","env","NODE_ENV","lanyonEnv","JEKYLL_ENV","LANYON_PROJECT","projectDir","stick","cacheDir","gitRoot","npmRoot","match","initProject","forEach","hook","needEnv","split","squashedHooks","isArray","join","exe","writeConfig","isFunction","err","isString","replace","lanyonDir","contentBuildDir","npmBins","name","tests","found","test","Error","pat","RegExp","binDir","mode","Object","keys"],"mappings":"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","file":"cli.js","sourcesContent":["\nconst utils       = require('./utils')\nutils.preferLocalPackage(process.argv, __filename, process.cwd(), 'lanyon', 'lib/cli.js', require('../package.json').version)\nconst _           = require('lodash')\nconst config      = require('./config')\nconst shell       = require('shelljs')\nconst scrolex     = require('scrolex')\nconst runtime     = config.runtime\n// var debug      = require('depurar')('lanyon')\n// const stripIndent = require('common-tags/lib/stripIndent')\n\nif (require.main !== module) {\n  scrolex.failure(`Please only used this module the commandline: node src/cli.js`)\n  process.exit(1)\n}\n\nconst scripts = {\n  'build:assets'             : 'webpack --config [cacheDir]/webpack.config.js',\n  'build:content:incremental': 'jekyll build --incremental --source [projectDir] --destination [contentBuildDir] --verbose --config [projectDir]/_config.yml,[cacheDir]/jekyll.config.yml,[cacheDir]/jekyll.lanyon_assets.yml',\n  'build:content:watch'      : 'nodemon --config [cacheDir]/nodemon.config.json --exec \"[lanyon] build:content:incremental' + '\"',\n  'build:content'            : 'jekyll build --source [projectDir] --destination [contentBuildDir] --verbose --config [projectDir]/_config.yml,[cacheDir]/jekyll.config.yml,[cacheDir]/jekyll.lanyon_assets.yml',\n  // @todo: useless until we have: https://github.com/imagemin/imagemin-cli/pull/11 and https://github.com/imagemin/imagemin/issues/226\n  'build:images'             : 'imagemin [projectDir]/assets/images --out-dir=[projectDir]/assets/build/images',\n  'build'                    : '[lanyon] build:assets && [lanyon] build:content', // <-- parrallel won't work for production builds, jekyll needs to copy assets into _site\n  'container:connect'        : utils.dockerCmd(runtime, 'sh', '--interactive --tty'),\n  'deploy'                   : require('./deploy'),\n  'encrypt'                  : require('./encrypt'),\n  'help'                     : 'jekyll build --help',\n  'list:ghpgems'             : 'bundler exec github-pages versions --gem',\n  'install'                  : require('./install'),\n  'serve'                    : 'browser-sync start --config [cacheDir]/browsersync.config.js',\n  'start'                    : '[lanyon] build:assets && [lanyon] build:content:incremental && parallelshell \"[lanyon] build:content:watch\" \"[lanyon] serve\"',\n}\n\nif (runtime.trace) {\n  scripts['build:content:incremental'] += ' --trace'\n  scripts['build:content']             += ' --trace'\n}\n\nconst cmdName = process.argv[2]\nlet cmd       = scripts[cmdName]\n\nscrolex.setOpts({\n  announce             : true,\n  addCommandAsComponent: true,\n  components           : `lanyon>${cmdName}`,\n  env                  : Object.assign({}, process.env, {\n    NODE_ENV      : runtime.lanyonEnv,\n    JEKYLL_ENV    : runtime.lanyonEnv,\n    LANYON_PROJECT: runtime.projectDir, // <-- to preserve the cwd over multiple nested executes, if it wasn't initially set\n  }),\n})\n\nscrolex.stick(`cacheDir is \"${runtime.cacheDir}\". `)\nscrolex.stick(`gitRoot is \"${runtime.gitRoot}\". `)\nscrolex.stick(`npmRoot is \"${runtime.npmRoot}\". `)\n\n// Create asset dirs and git ignores\nif (cmdName.match(/^build|install|start/)) {\n  utils.initProject(runtime)\n}\n\n// Run Hooks\nif (cmdName.match(/^build:(assets|content)/)) {\n  ['prebuild', 'prebuild:production', 'prebuild:development'].forEach(hook => {\n    if (runtime[hook]) {\n      const needEnv = hook.split(':')[1]\n      if (!needEnv || runtime.lanyonEnv === needEnv) {\n        let squashedHooks = runtime[hook]\n        if (_.isArray(runtime[hook])) {\n          squashedHooks = runtime[hook].join(' && ')\n        }\n        scrolex.exe(squashedHooks, {\n          cwd: runtime.projectDir,\n        })\n        // scrolex.stick(`${hook} done. `)\n      }\n    }\n  })\n}\n\n// Write all config files to cacheDir\nscrolex.stick('Writing configs. ')\nutils.writeConfig(config)\n\n// Run cmd arg\nif (_.isFunction(cmd)) {\n  scrolex.stick(`Running ${cmdName} function. `)\n  cmd(runtime, err => {\n    if (err) {\n      scrolex.failure(`${cmdName} function exited with error ${err}`)\n      process.exit(1)\n    }\n    scrolex.stick(`${cmdName} done. `)\n  })\n} else if (_.isString(cmd)) {\n  cmd = cmd.replace(/\\[lanyon]/g, `node ${__filename}`) // eslint-disable-line no-path-concat\n  cmd = cmd.replace(/\\[lanyonDir]/g, runtime.lanyonDir)\n  cmd = cmd.replace(/\\[contentBuildDir]/g, runtime.contentBuildDir)\n  cmd = cmd.replace(/\\[projectDir]/g, runtime.projectDir)\n  cmd = cmd.replace(/\\[cacheDir]/g, runtime.cacheDir)\n\n  const npmBins = {\n    'browser-sync' : '/node_modules/browser-sync/bin/browser-sync.js',\n    'webpack'      : '/node_modules/webpack/bin/webpack.js',\n    'imagemin'     : '/node_modules/imagemin-cli/cli.js',\n    'nodemon'      : '/node_modules/nodemon/bin/nodemon.js',\n    'npm-run-all'  : '/node_modules/npm-run-all/bin/npm-run-all/index.js',\n    'parallelshell': '/node_modules/parallelshell/index.js',\n  }\n  for (const name in npmBins) {\n    const tests = [\n      runtime.lanyonDir + npmBins[name],\n      runtime.gitRoot + npmBins[name],\n      runtime.projectDir + npmBins[name],\n      `${runtime.projectDir}/..${npmBins[name]}`,\n    ]\n\n    let found = false\n    tests.forEach(test => {\n      if (shell.test('-f', test)) {\n        npmBins[name] = test\n        found         = true\n      }\n    })\n\n    if (!found) {\n      throw new Error(`Cannot find dependency \"${name}\" in \"${tests.join('\", \"')}\"`)\n    }\n    const pat = new RegExp(`(\\\\s|^)${name}(\\\\s|$)`)\n    cmd = cmd.replace(pat, `$1node ${npmBins[name]}$2`)\n  }\n\n  cmd = cmd.replace(/(\\s|^)jekyll(\\s|$)/, `$1${runtime.binDir}/jekyll$2`)\n  cmd = cmd.replace(/(\\s|^)bundler(\\s|$)/, `$1${runtime.binDir}/bundler$2`)\n\n  scrolex.exe(cmd, {\n    mode: cmdName === 'start' ? 'singlescroll' : 'passthru',\n    cwd : runtime.cacheDir,\n  })\n} else {\n  scrolex.failure(`\"${cmdName}\" is not a valid Lanyon command. Pick from: ${Object.keys(scripts).join(', ')}.`)\n}\n"]}