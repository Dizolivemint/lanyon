{"version":3,"sources":["../src/install.js"],"names":["require","path","utils","shell","os","fs","_","oneLine","stripIndent","scrolex","persistOpts","announce","addCommandAsComponent","components","main","module","failure","process","argv","exit","exports","runtime","cb","deps","cloneDeep","prerequisites","name","exeSuffix","exe","versionCheck","envPrefix","passEnv","rubyProvider","lanyonReset","stick","rm","binDir","satisfied","buff","readFileSync","trim","indexOf","ruby","replace","writeShim","gem","bundler","undefined","which","stdout","env","DOCKER_BUILD","cache","DOCKER_RESET","cacheDir","lanyonVersion","sh","dockerCmd","jekyll","exec","code","preferred","localGemArgs","GEM_HOME","GEM_PATH","Object","keys","length","vals","key","val","push","join","platform","dep","shim","dash","shimPath","writeFileSync","projectDir","lanyonUpdateGemLockfile","fsCopySync","lanyonDir"],"mappings":"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","file":"install.js","sourcesContent":["require('babel-polyfill')\nconst path        = require('path')\nconst utils       = require('./utils')\nconst shell       = require('shelljs')\nconst os          = require('os')\nconst fs          = require('fs')\n// var debug      = require('depurar')('lanyon')\nconst _           = require('lodash')\nconst oneLine     = require('common-tags/lib/oneLine')\nconst stripIndent = require('common-tags/lib/stripIndent')\nconst scrolex     = require('scrolex').persistOpts({\n  announce             : true,\n  addCommandAsComponent: true,\n  components           : `lanyon>install`,\n})\n\nif (require.main === module) {\n  scrolex.failure(`Please only used this module via require, or: src/cli.js ${process.argv[1]}`)\n  process.exit(1)\n}\n\nmodule.exports = async (runtime, cb) => {\n  // Set prerequisite defaults\n  let deps = _.cloneDeep(runtime.prerequisites)\n  for (const name in deps) {\n    if (!deps[name].exeSuffix) {\n      deps[name].exeSuffix = ''\n    }\n    if (!deps[name].exe) {\n      deps[name].exe = name\n    }\n    if (!deps[name].versionCheck) {\n      deps[name].versionCheck = `${deps[name].exe} -v`\n    }\n  }\n\n  let envPrefix    = ''\n  const passEnv    = {}\n  let rubyProvider = ''\n\n  if (runtime.lanyonReset) {\n    scrolex.stick('Removing existing shims')\n    shell.rm('-f', `${runtime.binDir}/*`)\n  }\n\n  if (!utils.satisfied(runtime, 'node')) {\n    scrolex.failure('No satisfying node found')\n    shell.exit(1)\n  }\n\n  // Detmine optimal rubyProvider and adjust shim configuration\n  if (utils.satisfied(runtime, 'ruby', `${runtime.binDir}/ruby -v`, 'ruby-shim')) {\n    const buff = fs.readFileSync(`${runtime.binDir}/ruby`, 'utf-8').trim()\n    if (buff.indexOf('docker') !== -1) {\n      rubyProvider = 'docker'\n    } else if (buff.indexOf('rvm') !== -1) {\n      rubyProvider = 'rvm'\n    } else if (buff.indexOf('rbenv') !== -1) {\n      rubyProvider = 'rbenv'\n    } else {\n      rubyProvider = 'system'\n    }\n    scrolex.stick(`Found a working shim - determined to be a \"${rubyProvider}\" rubyProvider`)\n    deps.ruby.exe          = fs.readFileSync(`${runtime.binDir}/ruby`, 'utf-8').trim().replace(' $*', '')\n    deps.ruby.writeShim    = false\n    deps.ruby.versionCheck = `${deps.ruby.exe} -v${deps.ruby.exeSuffix}`\n    deps.gem.exe           = fs.readFileSync(`${runtime.binDir}/gem`, 'utf-8').trim().replace(' $*', '')\n    deps.gem.writeShim     = false\n    deps.bundler.exe       = `${runtime.binDir}/bundler` // <-- not a lanyon shim, it's a real gem bin\n    deps.bundler.writeShim = false\n  } else if (utils.satisfied(runtime, 'ruby', undefined, 'system')) {\n    rubyProvider = 'system'\n    deps.gem.exe     = shell.which('gem').stdout\n    deps.bundler.exe = shell.which('bundler').stdout\n  } else if (utils.satisfied(runtime, 'docker')) {\n    rubyProvider = 'docker'\n    if (process.env.DOCKER_BUILD === '1') {\n      const cache = process.env.DOCKER_RESET === '1' ? ' --no-cache' : ''\n      await scrolex.exe(`cd \"${runtime.cacheDir}\" && docker build${cache} -t kevinvz/lanyon:${runtime.lanyonVersion} .`)\n      await scrolex.exe(`cd \"${runtime.cacheDir}\" && docker push kevinvz/lanyon:${runtime.lanyonVersion}`)\n    }\n    deps.sh.exe     = utils.dockerCmd(runtime, 'sh', '--interactive --tty')\n    deps.ruby.exe   = utils.dockerCmd(runtime, 'ruby')\n    deps.jekyll.exe = utils.dockerCmd(runtime, 'bundler exec jekyll')\n  } else if (utils.satisfied(runtime, 'rbenv') && shell.exec('rbenv install --help', { 'silent': true }).code === 0) {\n    // rbenv does not offer installing of rubies by default, it will also require the install plugin --^\n    rubyProvider = 'rbenv'\n    await scrolex.exe(`bash -c \"rbenv install --skip-existing '${deps.ruby.preferred}'\"`)\n    deps.ruby.exe          = `bash -c \"eval $(rbenv init -) && rbenv shell '${deps.ruby.preferred}' &&`\n    deps.ruby.exeSuffix    = '\"'\n    deps.ruby.versionCheck = `${deps.ruby.exe}ruby -v${deps.ruby.exeSuffix}`\n  } else if (utils.satisfied(runtime, 'rvm')) {\n    rubyProvider = 'rvm'\n    await scrolex.exe(`bash -c \"rvm install '${deps.ruby.preferred}'\"`)\n    deps.ruby.exe          = `bash -c \"rvm '${deps.ruby.preferred}' exec`\n    deps.ruby.exeSuffix    = '\"'\n    deps.ruby.versionCheck = `${deps.ruby.exe} ruby -v${deps.ruby.exeSuffix}`\n  } else {\n    scrolex.failure('Ruby version not satisfied, and exhausted ruby version installer helpers (rvm, rbenv, brew)')\n    process.exit(1)\n  }\n\n  // Verify Ruby\n  if (!utils.satisfied(runtime, 'ruby', deps.ruby.versionCheck, 'verify')) {\n    scrolex.failure('Ruby should have been installed but still not satisfied')\n    process.exit(1)\n  }\n\n  if (rubyProvider !== 'docker') {\n    // Install Bundler\n    deps.bundler.exe = `${deps.ruby.exe} ${deps.bundler.exe}`\n    if (!utils.satisfied(runtime, 'bundler', `${deps.bundler.exe} -v${deps.ruby.exeSuffix}`)) {\n      let localGemArgs = ''\n      if (rubyProvider === 'system') {\n        localGemArgs = `--binDir='${runtime.binDir}' --install-dir='vendor/gem_home'`\n      }\n\n      await scrolex.exe(oneLine`\n        cd \"${runtime.cacheDir}\" && (\n          ${deps.ruby.exe} ${deps.gem.exe} install ${localGemArgs}\n            --no-rdoc\n            --no-ri\n          bundler -v '${deps.bundler.preferred}'\n          ${deps.ruby.exeSuffix}\n        )\n      `)\n\n      if (rubyProvider === 'system') {\n        deps.bundler.exe = `${runtime.binDir}/bundler`\n        passEnv.GEM_HOME = 'vendor/gem_home'\n        passEnv.GEM_PATH = 'vendor/gem_home'\n\n        if (Object.keys(passEnv).length > 0) {\n          const vals = []\n          for (const key in passEnv) {\n            const val = passEnv[key]\n            vals.push(`${key}=${val}`)\n          }\n          envPrefix = `env ${vals.join(' ')} `\n        }\n\n        deps.bundler.exe = envPrefix + deps.bundler.exe\n      }\n    }\n\n    // Configure Bundler (nokogiri)\n    if (os.platform() === 'darwin' && shell.exec('brew -v', { 'silent': true }).code === 0) {\n      await scrolex.exe(oneLine`\n        cd \"${runtime.cacheDir}\" && (\n          brew install libxml2;\n          ${deps.bundler.exe} config build.nokogiri\n            --use-system-libraries\n            --with-xml2-include=$(brew --prefix libxml2 | sed 's@_[0-9]*$@@')/include/libxml2\n          ${deps.ruby.exeSuffix}\n        )\n      `)\n    } else {\n      await scrolex.exe(oneLine`\n        cd \"${runtime.cacheDir}\" && (\n          ${deps.bundler.exe} config build.nokogiri\n            --use-system-libraries\n          ${deps.ruby.exeSuffix}\n        )\n      `)\n    }\n\n    deps.jekyll.exe = `${deps.bundler.exe} exec jekyll`\n\n    // Install Gems from Gemfile bundle\n    await scrolex.exe(oneLine`\n      cd \"${runtime.cacheDir}\" && (\n        ${deps.bundler.exe} install\n          --binstubs='${runtime.binDir}'\n          --path='vendor/bundler'\n          ${deps.ruby.exeSuffix}\n        ||\n        ${deps.bundler.exe} update\n        ${deps.ruby.exeSuffix}\n      )\n    `)\n  }\n\n  // Write shims\n  for (const name in deps) {\n    const dep = deps[name]\n    if (dep.writeShim) {\n      let shim = `${envPrefix + dep.exe.trim()} $*${deps.ruby.exeSuffix}\\n`\n      if (name === 'dash') {\n        shim = `${envPrefix + dep.exe.trim()} $*${deps.dash.exeSuffix}\\n`\n      }\n      var shimPath = path.join(runtime.binDir, name)\n      fs.writeFileSync(shimPath, shim, { 'encoding': 'utf-8', 'mode': '755' })\n      scrolex.stick(`Installed: ${name} shim to: ${shimPath} ..`)\n    }\n  }\n\n  shimPath = path.join(runtime.binDir, 'deploy')\n  scrolex.stick(`Installed: deploy shim to: ${shimPath} ..`)\n  fs.writeFileSync(shimPath, stripIndent`\n    #!/bin/sh -ex\n    cd \"${runtime.projectDir}\"\n    (npm run build:production || npm run web:build:production) && (npm run deploy || npm run web:deploy)\n  `, { 'encoding': 'utf-8', 'mode': '755' })\n\n  if (runtime.lanyonUpdateGemLockfile === true) {\n    utils.fsCopySync(`${runtime.cacheDir}/Gemfile.lock`, `${runtime.lanyonDir}/Gemfile.lock`)\n  }\n\n  cb(null)\n}\n"]}